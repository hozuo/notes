## Java虚拟机

### 镜像

基于centos7构建,使用的java版本是1.8（jdk-8u261-linux-x64.tar.gz），dockerfile如下

```dockerfile
#指定基础镜像
FROM centos:7

#作者
LABEL maintainer=hozuo

#指定镜像的工作目录
WORKDIR /usr/local/src

#修改yum源
RUN rm -rf /etc/yum.repos.d/*
ADD yum.repos.d /etc/yum.repos.d/

#安装mysqldump
RUN yum -y install holland-mysqldump.noarch && yum clean all

# java
ADD jdk-8u261-linux-x64.tar.gz /usr/local/

ENV JAVA_HOME=/usr/local/jdk1.8.0_261
ENV PATH=$JAVA_HOME/bin:$PATH
ENV CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar

#中文
RUN yum install kde-l10n-Chinese -y && yum install glibc-common -y && localedef -c -f UTF-8 -i zh_CN zh_CN.utf8 && yum clean all
ENV LC_ALL zh_CN.UTF-8

#启动文件
ADD start.sh /usr/local/src
RUN chmod +x  /usr/local/src/start.sh

#时区
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo 'Asia/Shanghai' >/etc/timezone

#挂载卷
RUN mkdir /usr/local/src/jar && mkdir -p /usr/local/src/mysql/backup && mkdir /usr/local/src/cmd && mkdir /springLogs

#容器启动时需要执行的命令
ENTRYPOINT ["/usr/local/src/start.sh"]
```

启动文件（start.sh）用于启动指定位置的jar包，需保证只有一个.jar文件存在

```
#!/bin/bash

java -jar /usr/local/src/jar/*.jar
```

### 构建

镜像启动时会检索卷中的jar包，更新时将卷清空放入新jar包

卷目录

```
/var/lib/docker/volumes/xdw-swamp_xdw-java8-data/_data
```



### 服务创建（未使用）

这条语句创建了一个java8服务，挂载了多个卷，生成的容器关闭后可以再次生成一个复制

```shell
docker service create --mount source=xdw-java8-data,target=/usr/local/src/jar --mount source=xdw-mysql-backup,target=/usr/local/src/mysql/backup --mount source=xdw-java8-cmd,target=/usr/local/src/cmd --mount source=xdw-java8-logs,target=/springLogs --network my-multihost-network --replicas 1 -p 2000:2000 -d --name xdw-java8-service xdw-java8
```

### compose up部署

使用yml文件可以方便的统一管理配置

一个示例文件如下

```yml
version: "3.3"
services:

  java8:
    image: xdw-java8-image
    networks: 
      - xdw-muti-network
    ports:
      - "2000:2000"
    volumes:
      - xdw-java8-data:/usr/local/src/jar
      - type: volume
        source: xdw-mysql-backup
        target: /usr/local/src/mysql/backup
      - xdw-java8-cmd:/usr/local/src/cmd
      - xdw-java8-logs:/springLogs
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    secrets:
      - mysql-password
    #entrypoint: ["/usr/local/src/start.sh"]

  mysql:
    image: mariadb
    networks:
      - xdw-muti-network
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql-password
      MYSQL_DATABASE: xdwManager
      MYSQL_USER: guest
      MYSQL_PASSWORD_FILE: /run/secrets/mysql-password-guest
    ports:
      - "3306:3306"
    volumes:
      - xdw-mysql-data:/var/lib/mysql
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    secrets:
      - mysql-password
      - mysql-password-guest

  nginx:
    image: xdw-nginx-image
    ports:
      - "8080:80"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
        

secrets:
  mysql-password:
    external: true
  mysql-password-guest:
    external: true

networks:
  xdw-muti-network:

volumes:
  xdw-java8-data:
  xdw-java8-cmd:
  xdw-java8-logs:
  xdw-mysql-backup:
  xdw-mysql-data:
```

> 在./目录使用docker-compose up部署，会提示警告，你试图用普通方式`docker-compose up`部署一个集群`swamp`，这样的结果是部署了多个容器，并且会忽略deploy属性，会创建`compose_`开头的资源，例如卷和网络

### 集群部署

使用`docker stack deploy`部署一个集群，包含多个服务，语法如下

> docker stack deploy [OPTIONS] STACK

`--compose-file`指定文件，项目使用的部署语句如下，该部署方式会创建`xdw-swamp_`开头的资源

```shell
docker stack deploy --compose-file docker-compose.yml xdw-swamp
```

将部署模式写到run.sh中

```shell
docker service rm xdw-swamp_java8
docker service rm xdw-swamp_mysql
docker service rm xdw-swamp_nginx
docker stack deploy --compose-file docker-compose.yml xdw-swamp
```

相同原理的stop.sh

```shell
docker service rm xdw-swamp_java8
docker service rm xdw-swamp_mysql
docker service rm xdw-swamp_nginx
```

这些文件现在放在如下目录 2020年7月23日

```
/usr/local/src/compose
```

### 数据卷

xdw-java8-data：程序jar包目录，容器启动自动运行

xdw-java8-cmd：脚本目录

xdw-java8-logs：日志目录

xdw-mysql-backup：mysql的sql文件备份目录

### 备份脚本

> TODO 现在使用的密码是原文，使用的ip地址是公网ip。密码可以使用docker secret，ip地址可以使用服务的docker network ip 2020年7月23日
>

backup.sh

创建备份脚本（放在/usr/local/src/cmd/backup.sh）

$1:数据库ip

$2:操作用户，自动填auto

$3:创建时间，手动由java服务器提供，自动由当前操作系统提供

```shell
#!/bin/bash

DATE=$(date "+%Y%m%d_%H%M%S")

mysqldump -h $1 -u root -p'SfSPN8ujTG97ctCQtF0GTyIeMil4oHbeANviZVU2SXLnsCWsT5DHcBxjRyH6Isk' xdwManager > /usr/local/src/mysql/backup/xdwBak_$2_$DATE.sql
```

java执行脚本

```
sh /usr/local/src/cmd/backup.sh 10.0.1.218 admin 
```

### 还原脚本

restore.sh

$1:数据库ip

$2:文件名

```shell
#!/bin/bash

DATE=$(date "+%Y%m%d_%H%M%S")

#备份当前记录
mysqldump -h $1 -u root -p'SfSPN8ujTG97ctCQtF0GTyIeMil4oHbeANviZVU2SXLnsCWsT5DHcBxjRyH6Isk' xdwManager > /usr/local/src/mysql/backup/xdwBak_beforeRestore[$2]_$DATE.sql

#还原
mysql -h $1 -uroot -pSfSPN8ujTG97ctCQtF0GTyIeMil4oHbeANviZVU2SXLnsCWsT5DHcBxjRyH6Isk -DxdwManager< /usr/local/src/mysql/backup/$2

#备份还原后记录
mysqldump -h $1 -u root -p'SfSPN8ujTG97ctCQtF0GTyIeMil4oHbeANviZVU2SXLnsCWsT5DHcBxjRyH6Isk' xdwManager > /usr/local/src/mysql/backup/xdwBak_afterRestore[$2]_$DATE.sql
```

java执行脚本

```
sh /usr/local/src/cmd/restore.sh 10.0.1.218 xdwBak_shell_20200718_154733.sql
```

### 删除脚本

delete.sh

$1:文件名

```shell
#!/bin/bash

rm -f /usr/local/src/mysql/backup/$1
```

java执行脚本

```
sh /usr/local/src/cmd/restore.sh xdwBak_shell_20200718_154733.sql
```

## 数据库

### 镜像

基于mariadb，原生镜像无额外配置；密码是`SfSPN8ujTG97ctCQtF0GTyIeMil4oHbeANviZVU2SXLnsCWsT5DHcBxjRyH6Isk`。添加guest用户密码`980305`，均使用docker secret配置

### 服务创建（未使用）

```shell
docker service create -p 3306:3306 --mount source=xdw-mysql-data,target=/var/lib/mysql --mount source=xdw-mysql-backup,target=/usr/local/src/mysql --replicas 1 --name mysql-service --network my-multihost-network -e MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql-password --secret mysql-password mariadb
```

## Web前端

### 镜像

基于Nginx构建，原生镜像，添加了前端项目的文件

Dockerfile

```dockerfile
FROM nginx

MAINTAINER hozuo

RUN rm /etc/nginx/conf.d/default.conf

ADD default.conf /etc/nginx/conf.d/

COPY dist/ /usr/share/nginx/html/
```



### 配置

default.conf

```
server {
    listen       80;
	# 修改为docker服务宿主机的ip
    server_name  localhost;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
        try_files $uri $uri/ /index.html =404;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   html;
    }
}
```

### 构建

**本地构建**

管理员powershell在项目根目录运行如下语句

```powershell
npm install

npm run build
```

**Docker构建**

整个项目打包zip，ftp到服务器解压缩，根目录运行构建语句

```shell
cd /usr/local/src/build_nginx/

unzip xdw_manager_web

cd xdw_manager_web

sh uat-build.sh
```

uat-build.sh内容如下

```
docker build -t xdw-nginx-image .
```

